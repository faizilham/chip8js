<!DOCTYPE html />
<html>
  <head>
  </head>
  <body>
    <div class="emscripten_border">
      <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
    </div>
    <input type="file" id="file_select" value="Load ROM File"/> <button id="start_button" onclick="startstop()" >Start</button> <span id="notification"></span>
    <script type="text/javascript">
      var start_button = document.getElementById("start_button");
      var file_select = document.getElementById("file_select");
      var notification = document.getElementById("notification");

      var canvas = document.getElementById('canvas');
      canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);

      var Module = {
        canvas: canvas,
        noInitialRun: true
      };

      var playing = false;

      function startstop(){
        if (!playing){
          load_file();
        }else{
          stop_machine();
        }
      }

      function flipstate(){
        if (!playing){
          playing = true;
          start_button.innerHTML = "Stop";
        }else{
          playing = false;
          start_button.innerHTML = "Start";
        }
      }

      function init_machine(){
        flipstate();
      }

      function stop_machine(){
        flipstate();
        notification.innerHTML = "";
        Module._stop_loop();
      }

      function notify_stop(){
        //alert("Program halted, press stop to turn off the machine");
        notification.innerHTML = "Program halted, press stop to turn off the machine";
      }

      function load_file(){
        var file_url = file_select.files[0];
        if (!file_url){
          alert("Please load a ROM file");
          return;
        } 

        reader = new FileReader();
        reader.addEventListener("loadend", function() {
          result = new Uint8Array(reader.result);

          var fp = FS.open("/temp.rom", "w");
          FS.write(fp, result, 0, result.length, 0);
          FS.close(fp);

          init_machine();

          Module._main();
        });

        reader.readAsArrayBuffer(file_url);
      }
    </script>
    <script async type="text/javascript" src="chip8.js"></script>
  </body>
</html>